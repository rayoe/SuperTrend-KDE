//@version=5
indicator("SuperTrend Kernel Optimized", overlay=true)

// input length, multiplier and bandwidth
length = input(10, title="Length")
factor = input(1.5, title="Multiplier")
bandwidth = input(1.0, title="Bandwidth")
atr_len = input.int(10, "ATR Length", group = "SuperTrend Settings")

gaussian (float distance, float bandwidth = 1.0) => 1.0 / math.sqrt(2.0 * math.pi) * math.pow(math.e, -0.5 * math.pow(distance / bandwidth, 2.0))

atr = ta.atr(atr_len)

SuperTrend(factor, atr) =>
    src = hl2
    upperBand = src + factor * atr
    lowerBand = src - factor * atr
    prevLowerBand = nz(lowerBand[1])
    prevUpperBand = nz(upperBand[1])

    lowerBand := lowerBand > prevLowerBand or close[1] < prevLowerBand ? lowerBand: prevLowerBand
    upperBand := upperBand < prevUpperBand or close[1] > prevUpperBand ? upperBand : prevUpperBand
    int dir = na
    float supertrend = na
    prevSuperTrend = supertrend[1]
    if na(atr[1])
        dir := 1
        supertrend := lowerBand
    else if prevSuperTrend == prevUpperBand
        dir := close > upperBand ? -1 : 1
    else
        dir := close < lowerBand ? 1 : -1
    supertrend := dir == 1 ? lowerBand : upperBand[1]
    [supertrend, dir]


[supertrend, dir] = SuperTrend(factor, atr)

upTrend = plot(close > supertrend ? supertrend : na, color=color.green, style=plot.style_linebr)
downTrend = plot(close < supertrend ? supertrend : na, color=color.red, style=plot.style_linebr, force_overlay=false)
bodyMiddle = plot(barstate.isfirst ? na : (open + close) / 2, display=display.none)

fill(bodyMiddle, upTrend, (open + close) / 2, supertrend, color.green, color.new(color.green, 90))
fill(bodyMiddle, downTrend, supertrend, (open + close) / 2, color.red, color.new(color.red, 90))

plotshape(ta.crossunder(dir, 0) ? supertrend : na, style=shape.labelup, location=location.abovebar, color=color.green, text="GREEN", textcolor=chart.fg_color, size=size.small)
plotshape(ta.crossover(dir, 0) ? supertrend : na, style=shape.labeldown, location=location.belowbar, color=color.red, text="RED", textcolor=chart.fg_color, size=size.small) 


